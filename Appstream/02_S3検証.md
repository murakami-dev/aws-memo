# ネット経由ではなくS3経由でアプリをおとす
AppStream2.0 インターネット経由でインストールできないアプリをS3経由でインストールする
https://dev.classmethod.jp/articles/appstream2-install-from-s3/　　

## S3にアプリの実行ファイルを保存しておく
![image](https://user-images.githubusercontent.com/60077121/94649008-bbdaf500-032e-11eb-9d3f-5a4a8db0dbbb.png)

## VPCエンドポイントの作成
インバウンドをSWXのVPNに制限  
https://docs.aws.amazon.com/ja_jp/appstream2/latest/developerguide/creating-streaming-from-interface-vpc-endpoints.html
![image](https://user-images.githubusercontent.com/60077121/94648628-e5dfe780-032d-11eb-8902-9d8f0c40884a.png)


## IAMロールの作成（イメージビルダーインスタンスに付与）
https://docs.aws.amazon.com/ja_jp/appstream2/latest/developerguide/using-iam-roles-to-grant-permissions-to-applications-scripts-streaming-instances.html
![image](https://user-images.githubusercontent.com/60077121/94648873-6dc5f180-032e-11eb-8fcc-11e252e22f5b.png)
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::appstream-20200930/*"
        }
    ]
}
```

## イメージビルダーインスタンスの作成
- 上記で作成したVPCエンドポイント、IAMロールを指定
- イメージビルダーインスタンスのENIは~~プライベートサブネットに配置。インターネットアクセスは有効化せず、NATGWから外に出るように設定。~~  パブリックサブネットに配置（プライベートに置くのがベストプラクティスだが面倒。以下失敗の理由）。
![image](https://user-images.githubusercontent.com/60077121/94655956-5c82e200-033a-11eb-92bf-cf6621718b54.png)


### PC->イメージビルダーインスタンスに接続（失敗）
そもそもprivate-subnetにENIあるので、SGどうこうの設定ではなく、ENIまでたどり着けない。
![image](https://user-images.githubusercontent.com/60077121/94653423-83d7b000-0336-11eb-9a7f-b4774ac05673.png)  
※PC->踏み台Windows->イメージビルダーインスタンスも無理。　
**結論：イメージビルダーインスタンスをプライベートサブネットに配置するにはClientVPNなど接続元から当該プライベートサブネットにアクセスできる手段ありきのとき。**

## イメージビルダーインスタンスでの操作
- powershell
```
PS C:\Users\ImageBuilderAdmin> aws sts get-caller-identity
{
    "UserId": "AROAIICB4SCLPTGZ635HU:i-043430d4f5b2466dc",
    "Account": "970004987115",
    "Arn": "arn:aws:sts::970004987115:assumed-role/PhotonImageBuilderInstance/i-043430d4f5b2466dc"
}
```

普通にやると`Access Denyed`になる
```
PS C:\Users\ImageBuilderAdmin> aws s3api get-object --bucket appstream-20200930 --key WinMerge-2.16.8-x64-Setup.exe Downloads

An error occurred (AccessDenied) when calling the GetObject operation: Access Denied
```

aws s3api get-object --bucket appstream-20200930 --key WinMerge-2.16.8-x64-Setup.exe C:\Users\Administrator --profile appstream_machine_role


