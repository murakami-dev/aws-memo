スプリットトンネル無効の場合だとすぐつながるのに、有効だとしばらく待たないと通信できない？

# 目次
- [VPN接続先やピアリング先VPCのCIDRもClientVPNのRTBに書くべきか](#VPN接続先やピアリング先VPCのCIDRもClientVPNのRTBに書くべきか)
- [スプリットトンネル有効にしてclientVPNのルートテーブルに`0.0.0/0`を書いたらインターネットにはどう出るのか](#スプリットトンネル有効にしてclientVPNのルートテーブルに`0.0.0/0`を書いたらインターネットにはどう出るのか)

## VPN接続先やピアリング先VPCのCIDRもClientVPNのRTBに書くべきか

- スプリットトンネル無効の場合＝通信できた（当たり前）
```
C:\Users\user>ping 10.0.20.26

10.0.20.26 に ping を送信しています 32 バイトのデータ:
10.0.20.26 からの応答: バイト数 =32 時間 =78ms TTL=254
10.0.20.26 からの応答: バイト数 =32 時間 =75ms TTL=254
10.0.20.26 からの応答: バイト数 =32 時間 =43ms TTL=254
10.0.20.26 からの応答: バイト数 =32 時間 =59ms TTL=254

10.0.20.26 の ping 統計:
    パケット数: 送信 = 4、受信 = 4、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 43ms、最大 = 78ms、平均 = 63ms
```

- スプリットトンネル有効の場合＝ピアリング先VPCにも接続できた（なんで？）  
  - ClientVPNのルートテーブルは以下の状態
  ![image](https://user-images.githubusercontent.com/60077121/99199807-12b86300-27e5-11eb-951d-dcae1eb2a510.png)

```
C:\Users\user>ping 10.123.20.107　　##clientvpnと同じサブネット内のインスタンス（当然、通信可能）

10.123.20.107 に ping を送信しています 32 バイトのデータ:
172.30.0.2 からの応答: 宛先ホストに到達できません。
10.123.20.107 からの応答: バイト数 =32 時間 =61ms TTL=254
10.123.20.107 からの応答: バイト数 =32 時間 =151ms TTL=254
10.123.20.107 からの応答: バイト数 =32 時間 =45ms TTL=254

10.123.20.107 の ping 統計:
    パケット数: 送信 = 4、受信 = 4、損失 = 0 (0% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 45ms、最大 = 151ms、平均 = 85ms

C:\Users\user>ping 10.0.20.26　　##ピアリング先VPCのインスタンス

10.0.20.26 に ping を送信しています 32 バイトのデータ:
10.0.20.26 からの応答: バイト数 =32 時間 =46ms TTL=254
10.0.20.26 からの応答: バイト数 =32 時間 =60ms TTL=254
10.0.20.26 からの応答: バイト数 =32 時間 =67ms TTL=254
要求がタイムアウトしました。

10.0.20.26 の ping 統計:
    パケット数: 送信 = 4、受信 = 3、損失 = 1 (25% の損失)、
ラウンド トリップの概算時間 (ミリ秒):
    最小 = 46ms、最大 = 67ms、平均 = 57ms
```


## スプリットトンネル有効にしてclientVPNのルートテーブルに`0.0.0/0`を書いたらインターネットにはどう出るのか
- ここに答えがあった
 - https://dev.classmethod.jp/articles/aws-client-vpn-split-tunnel-internet/
- クライアントCIDRは`172.30.0.0/18`
- clentvpn接続前にIP`14.10.xx.xx`
```
C:\Users\user>route print
===========================================================================
インターフェイス一覧
 12...........................Wintun Userspace Tunnel
  3...0a 00 27 00 00 03 ......VirtualBox Host-Only Ethernet Adapter
  6...00 ff 57 13 42 f6 ......TAP-Windows Adapter V9
 21...28 7f cf 83 14 55 ......Microsoft Wi-Fi Direct Virtual Adapter
 10...2a 7f cf 83 14 54 ......Microsoft Wi-Fi Direct Virtual Adapter #2
 15...28 7f cf 83 14 54 ......Intel(R) Wireless-AC 9560 160MHz
 17...28 7f cf 83 14 58 ......Bluetooth Device (Personal Area Network)
  1...........................Software Loopback Interface 1
===========================================================================

IPv4 ルート テーブル
===========================================================================
アクティブ ルート:
ネットワーク宛先        ネットマスク          ゲートウェイ       インターフェイス  メトリック
          0.0.0.0          0.0.0.0     192.168.11.1     192.168.11.9     35
   18.180.170.121  255.255.255.255    192.168.100.1     192.168.11.9     35
   18.180.211.183  255.255.255.255     192.168.11.1     192.168.11.9     35
        127.0.0.0        255.0.0.0            リンク上         127.0.0.1    331
        127.0.0.1  255.255.255.255            リンク上         127.0.0.1    331
  127.255.255.255  255.255.255.255            リンク上         127.0.0.1    331
     192.168.11.0    255.255.255.0            リンク上      192.168.11.9    291
     192.168.11.9  255.255.255.255            リンク上      192.168.11.9    291
   192.168.11.255  255.255.255.255            リンク上      192.168.11.9    291
     192.168.56.0    255.255.255.0            リンク上      192.168.56.1    281
     192.168.56.1  255.255.255.255            リンク上      192.168.56.1    281
   192.168.56.255  255.255.255.255            リンク上      192.168.56.1    281
        224.0.0.0        240.0.0.0            リンク上         127.0.0.1    331
        224.0.0.0        240.0.0.0            リンク上      192.168.56.1    281
        224.0.0.0        240.0.0.0            リンク上      192.168.11.9    291
  255.255.255.255  255.255.255.255            リンク上         127.0.0.1    331
  255.255.255.255  255.255.255.255            リンク上      192.168.56.1    281
  255.255.255.255  255.255.255.255            リンク上      192.168.11.9    291
===========================================================================
固定ルート:
  なし

IPv6 ルート テーブル
===========================================================================
アクティブ ルート:
 If メトリック ネットワーク宛先      ゲートウェイ
 15    291 ::/0                     fe80::1aec:e7ff:fe12:8690
  1    331 ::1/128                  リンク上
 15    291 240b:250:4160:a000::/64  リンク上
 15    291 240b:250:4160:a000:5923:87f8:205b:d8b4/128
                                    リンク上
 15    291 240b:250:4160:a000:f95d:8b13:a90:168/128
                                    リンク上
  3    281 fe80::/64                リンク上
 15    291 fe80::/64                リンク上
  3    281 fe80::185:bc80:dd77:1f66/128
                                    リンク上
 15    291 fe80::f95d:8b13:a90:168/128
                                    リンク上
  1    331 ff00::/8                 リンク上
  3    281 ff00::/8                 リンク上
 15    291 ff00::/8                 リンク上
===========================================================================
固定ルート:
  なし
```

### まずはclientvpnルートテーブルに`10.123.0.0/16`だけの状態でインターネットに出る
- clientvpn接続してもスプリットされて`14.10.xx.xx`のまま（当然）

```
C:\Users\user>route print
===========================================================================
インターフェイス一覧
 12...........................Wintun Userspace Tunnel
  3...0a 00 27 00 00 03 ......VirtualBox Host-Only Ethernet Adapter
  6...00 ff 57 13 42 f6 ......TAP-Windows Adapter V9
 21...28 7f cf 83 14 55 ......Microsoft Wi-Fi Direct Virtual Adapter
 10...2a 7f cf 83 14 54 ......Microsoft Wi-Fi Direct Virtual Adapter #2
 15...28 7f cf 83 14 54 ......Intel(R) Wireless-AC 9560 160MHz
 17...28 7f cf 83 14 58 ......Bluetooth Device (Personal Area Network)
  1...........................Software Loopback Interface 1
===========================================================================

IPv4 ルート テーブル
===========================================================================
アクティブ ルート:
ネットワーク宛先        ネットマスク          ゲートウェイ       インターフェイス  メトリック
          0.0.0.0          0.0.0.0     192.168.11.1     192.168.11.9     35
          0.0.0.0        128.0.0.0      172.30.0.33       172.30.0.2     25
          0.0.0.0        128.0.0.0     172.30.0.129       172.30.0.2     25
       10.123.0.0      255.255.0.0       172.30.0.1       172.30.0.2     25                  ###コレ
   18.180.170.121  255.255.255.255    192.168.100.1     192.168.11.9     35
   18.180.211.183  255.255.255.255     192.168.11.1     192.168.11.9     35
        127.0.0.0        255.0.0.0            リンク上         127.0.0.1    331
        127.0.0.1  255.255.255.255            リンク上         127.0.0.1    331
  127.255.255.255  255.255.255.255            リンク上         127.0.0.1    331
        128.0.0.0        128.0.0.0      172.30.0.33       172.30.0.2     25
        128.0.0.0        128.0.0.0     172.30.0.129       172.30.0.2     25
       172.30.0.0  255.255.255.224            リンク上        172.30.0.2    281
       172.30.0.2  255.255.255.255            リンク上        172.30.0.2    281
      172.30.0.31  255.255.255.255            リンク上        172.30.0.2    281
     192.168.11.0    255.255.255.0            リンク上      192.168.11.9    291
     192.168.11.9  255.255.255.255            リンク上      192.168.11.9    291
   192.168.11.255  255.255.255.255            リンク上      192.168.11.9    291
     192.168.56.0    255.255.255.0            リンク上      192.168.56.1    281
     192.168.56.1  255.255.255.255            リンク上      192.168.56.1    281
   192.168.56.255  255.255.255.255            リンク上      192.168.56.1    281
        224.0.0.0        240.0.0.0            リンク上         127.0.0.1    331
        224.0.0.0        240.0.0.0            リンク上      192.168.56.1    281
        224.0.0.0        240.0.0.0            リンク上        172.30.0.2    281
        224.0.0.0        240.0.0.0            リンク上      192.168.11.9    291
  255.255.255.255  255.255.255.255            リンク上         127.0.0.1    331
  255.255.255.255  255.255.255.255            リンク上      192.168.56.1    281
  255.255.255.255  255.255.255.255            リンク上        172.30.0.2    281
  255.255.255.255  255.255.255.255            リンク上      192.168.11.9    291
===========================================================================
固定ルート:
  なし

IPv6 ルート テーブル
===========================================================================
アクティブ ルート:
 If メトリック ネットワーク宛先      ゲートウェイ
 15    291 ::/0                     fe80::1aec:e7ff:fe12:8690
  1    331 ::1/128                  リンク上
 15    291 240b:250:4160:a000::/64  リンク上
 15    291 240b:250:4160:a000:5923:87f8:205b:d8b4/128
                                    リンク上
 15    291 240b:250:4160:a000:f95d:8b13:a90:168/128
                                    リンク上
  3    281 fe80::/64                リンク上
  6    281 fe80::/64                リンク上
 15    291 fe80::/64                リンク上
  6    281 fe80::118:f6fe:e10b:6071/128
                                    リンク上
  3    281 fe80::185:bc80:dd77:1f66/128
                                    リンク上
 15    291 fe80::f95d:8b13:a90:168/128
                                    リンク上
  1    331 ff00::/8                 リンク上
  3    281 ff00::/8                 リンク上
  6    281 ff00::/8                 リンク上
 15    291 ff00::/8                 リンク上
===========================================================================
固定ルート:
  なし
```

### clientvpnのルートテーブルに`0.0.0.0/0`を書く


```
C:\Users\user>route print
===========================================================================
インターフェイス一覧
 12...........................Wintun Userspace Tunnel
  3...0a 00 27 00 00 03 ......VirtualBox Host-Only Ethernet Adapter
  6...00 ff 57 13 42 f6 ......TAP-Windows Adapter V9
 21...28 7f cf 83 14 55 ......Microsoft Wi-Fi Direct Virtual Adapter
 10...2a 7f cf 83 14 54 ......Microsoft Wi-Fi Direct Virtual Adapter #2
 15...28 7f cf 83 14 54 ......Intel(R) Wireless-AC 9560 160MHz
 17...28 7f cf 83 14 58 ......Bluetooth Device (Personal Area Network)
  1...........................Software Loopback Interface 1
===========================================================================

IPv4 ルート テーブル
===========================================================================
アクティブ ルート:
ネットワーク宛先        ネットマスク          ゲートウェイ       インターフェイス  メトリック
          0.0.0.0          0.0.0.0     192.168.11.1     192.168.11.9     35
          0.0.0.0          0.0.0.0       172.30.0.1       172.30.0.2     25
          0.0.0.0          0.0.0.0     172.30.0.129       172.30.0.2     25
          0.0.0.0          0.0.0.0      172.30.0.33       172.30.0.2     25
          0.0.0.0        128.0.0.0      172.30.0.33       172.30.0.2     25
          0.0.0.0        128.0.0.0     172.30.0.129       172.30.0.2     25
      3.113.121.8  255.255.255.255     192.168.11.1     192.168.11.9     35
       10.123.0.0      255.255.0.0       172.30.0.1       172.30.0.2     25
       10.123.0.0      255.255.0.0     172.30.0.129       172.30.0.2     25
       10.123.0.0      255.255.0.0      172.30.0.33       172.30.0.2     25
   18.180.170.121  255.255.255.255    192.168.100.1     192.168.11.9     35
   18.180.211.183  255.255.255.255     192.168.11.1     192.168.11.9     35
        127.0.0.0        255.0.0.0            リンク上         127.0.0.1    331
        127.0.0.1  255.255.255.255            リンク上         127.0.0.1    331
  127.255.255.255  255.255.255.255            リンク上         127.0.0.1    331
        128.0.0.0        128.0.0.0      172.30.0.33       172.30.0.2     25
        128.0.0.0        128.0.0.0     172.30.0.129       172.30.0.2     25
       172.30.0.0  255.255.255.224            リンク上        172.30.0.2    281
       172.30.0.2  255.255.255.255            リンク上        172.30.0.2    281
      172.30.0.31  255.255.255.255            リンク上        172.30.0.2    281
     192.168.11.0    255.255.255.0            リンク上      192.168.11.9    291
     192.168.11.9  255.255.255.255            リンク上      192.168.11.9    291
   192.168.11.255  255.255.255.255            リンク上      192.168.11.9    291
     192.168.56.0    255.255.255.0            リンク上      192.168.56.1    281
     192.168.56.1  255.255.255.255            リンク上      192.168.56.1    281
   192.168.56.255  255.255.255.255            リンク上      192.168.56.1    281
        224.0.0.0        240.0.0.0            リンク上         127.0.0.1    331
        224.0.0.0        240.0.0.0            リンク上      192.168.56.1    281
        224.0.0.0        240.0.0.0            リンク上        172.30.0.2    281
        224.0.0.0        240.0.0.0            リンク上      192.168.11.9    291
  255.255.255.255  255.255.255.255            リンク上         127.0.0.1    331
  255.255.255.255  255.255.255.255            リンク上      192.168.56.1    281
  255.255.255.255  255.255.255.255            リンク上        172.30.0.2    281
  255.255.255.255  255.255.255.255            リンク上      192.168.11.9    291
===========================================================================
固定ルート:
  なし

IPv6 ルート テーブル
===========================================================================
アクティブ ルート:
 If メトリック ネットワーク宛先      ゲートウェイ
 15    291 ::/0                     fe80::1aec:e7ff:fe12:8690
  1    331 ::1/128                  リンク上
 15    291 240b:250:4160:a000::/64  リンク上
 15    291 240b:250:4160:a000:5923:87f8:205b:d8b4/128
                                    リンク上
 15    291 240b:250:4160:a000:f95d:8b13:a90:168/128
                                    リンク上
  3    281 fe80::/64                リンク上
  6    281 fe80::/64                リンク上
 15    291 fe80::/64                リンク上
  6    281 fe80::118:f6fe:e10b:6071/128
                                    リンク上
  3    281 fe80::185:bc80:dd77:1f66/128
                                    リンク上
 15    291 fe80::f95d:8b13:a90:168/128
                                    リンク上
  1    331 ff00::/8                 リンク上
  3    281 ff00::/8                 リンク上
  6    281 ff00::/8                 リンク上
 15    291 ff00::/8                 リンク上
===========================================================================
固定ルート:
  なし
  ```
