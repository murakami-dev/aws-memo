- 送信元ポートは応答を待つために待機。相手にとっての送信先ポートになる
<img width="457" alt="スクリーンショット 2020-11-11 8 14 06" src="https://user-images.githubusercontent.com/60077121/98744940-ee7c1100-23f5-11eb-9c3a-7be640103eed.png">

# UDP
パケットフレームなど割愛

## UDPの解析に役立つWiresharkの機能
### 名前解決オプション
- L4の名前解決はポート番号をサービスに変換するだけ（443->https）
- edit -> preference
<img width="998" alt="スクリーンショット 2020-11-12 8 02 16" src="https://user-images.githubusercontent.com/60077121/98874383-8264e000-24bd-11eb-80d5-0a781cb943ad.png">

### UDPストリームオプション
- 行きのUDPと帰りのUDPを関連づけてくれる
![image](https://user-images.githubusercontent.com/60077121/98875187-09668800-24bf-11eb-9374-410b14a12b56.png)

### UDPパケットの解析
#### ファイアウォールはどう見えるか
- これでステートフルの意味が理解できる
- `フィルタリングルール`と`コネクションテーブル`で構成
- 実際に許可した通信のIPとポートからコネクションテーブルを作成し、アウトバウンドの許可を行う
<img width="519" alt="スクリーンショット 2020-11-12 8 25 25" src="https://user-images.githubusercontent.com/60077121/98876137-f5238a80-24c0-11eb-98c7-390c6b87453d.png">

# TCP
## パケットフォーマット
<img width="499" alt="スクリーンショット 2020-11-12 8 32 19" src="https://user-images.githubusercontent.com/60077121/98876430-9f9bad80-24c1-11eb-8559-33972d25d9f7.png">
<img width="335" alt="スクリーンショット 2020-11-12 8 33 02" src="https://user-images.githubusercontent.com/60077121/98876461-b04c2380-24c1-11eb-8187-52e24ab41789.png">

- 送信元・送信先ポート番号
- シーケンス番号：パケットを順番通りにつなぐための通し番号
- 確認応答番号：クライアントがサーバに出す「次はこのシーケンス番号以降のデータをください」というシーケンス番号+1の番号
- データオフセット：TCPヘッダの長さを32bit単位で表す。20バイトなら160bitなので`5`
- コントロールビット：コネクションの状態を表す6bit。3ウェイハンドシェイクで使用される。
  - ![image](https://user-images.githubusercontent.com/60077121/99009437-5a43b280-258b-11eb-9dfd-5507da4f5e80.png)

- ウィンドウサイズ：データを一時的に格納し、並べ替えなどを行うバッファ領域。
- その他は割愛

## 3ウェイハンドシェイク
![image](https://user-images.githubusercontent.com/60077121/99008511-ab52a700-2589-11eb-9a99-9c836114b965.png)
- コントロールビットのSYN,ACKが1のパケットを交換しあい、コネクションを確立する
- コネクション確立に交換するパケットと実際のデータを交換するパケットは別物（シーケンス番号も異なる）

### 3ウェイハンドシェイクのオプション
割愛

## 接続確立フェーズ（3ウェイハンドシェイクのあと)
- 3つの制御を組み合わせてデータ送信
  - `フロー制御`：受信側の端末が行う流量調整。ウィンドウサイズを送信側に通知して自分が受け取るデータの量を調整。送信側はこの通知がされるまでは可能な限りパケットを送信し続ける
  - `輻輳制御`：送信側の端末が行う流量調整。インターネットの混み具合などで決定。**送信側の送信ウィンドウサイズは受信側から通知される受診ウィンドウと自身の輻輳ウィンドウの小さい方に決定する**
    - 輻輳ウィンドウサイズの決定は`スロースタートフェーズ`と`輻輳回避フェーズ`で決定（詳細は割愛）
  - `再送制御`：受信側きっかけで始まる`重複ACK`と送信側きっかけで始まる`再送タイムアウト`がある
  - `重複ACK`：受信側で受け取ったパケットのシーケンス番号が飛び飛びになるとパケットロスが発生したと判断し、確認応答が同じACKを出す。
  - `再送タイムアウト`：送信側が持つ再送タイマーの時間よりも長くACKが帰ってこなかったら再送する

## クローズは4ウェイハンドシェイク
  - クローズするときはFIN/ACK -> ACK -> FIN/ACK -> ACK　の流れで双方から「終わりたいよ」「いいよ」を送り合う

## TCPの解析に役立つWiresharkの機能
### TCPストリームオプション
パケット一覧でTCPセグメントを右クリックして「追跡」→TCPストリーム
![image](https://user-images.githubusercontent.com/60077121/99458822-8044ca80-2970-11eb-8a96-6057b2d0f1e8.png)

- その他は割愛

## ファイアウォールはどう見えるか
基本はUDPと同じ。違いはコネクションの状態を示す列が加わっている
![image](https://user-images.githubusercontent.com/60077121/99459710-e251ff80-2971-11eb-8870-53621760faf4.png)

### その他の拡張機能
- TCP Fast Open(TFO)
  - RFC7413
  - 普通はアプリケーションデータをのせない3ウェイハンドシェイクのSYN,SYN/ACKにアプリケーションデータをのせる

その他は割愛

