# 文献
- 1.[プライベートネットワーク経由でAWS S3にアクセスする7つのアーキテクチャの紹介](https://dev.classmethod.jp/articles/how_to_private_connect_s3/)
- 2.[Direct Connectプライベート接続でS3へアクセスする高可用性な構成](https://dev.classmethod.jp/articles/direct-connect-s3/)
  - サイト間VPNでも考え方は同じはず
- 3.[[AWS Transit Gateway] マネージドサービスだけでオンプレミスからS3にプライベートアクセスしたい！](https://dev.classmethod.jp/articles/full-managed-s3-access-with-transit-gateway/)
  - VGWやVPC Peering,IGW,VPC EndpointはRTB編集不可で、インバウンド方向にはVPC内への通信しかルーティングできない。
  - TGWはRTB持てる。
  
# 文献2をもとに検証

## ClientインスタンスからS3へアクセス
- S3のバケットポリシー設定前（インターネットアクセス可能）
```
[ec2-user@ip-10-123-10-167 ~]$ aws s3 ls s3://test-s3-via-vpcendpoint
2020-12-20 02:54:31          8 murakami.txt
```

- S3のバケットポリシー設定後（VPCエンドポイントからのみアクセス可能）
 - これでエンドポイント経由でアクセスできなくなった。
```
[ec2-user@ip-10-123-10-167 ~]$ aws s3 ls s3://test-s3-via-vpcendpoint

An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied
```
- 一方でVPCエンドポイント経由ならアクセスできる
```
[ec2-user@ip-10-0-10-129 ~]$ aws s3 ls s3://test-s3-via-vpcendpoint
2020-12-20 02:54:31          8 murakami.txt
```


### バケットポリシー
```
{
   "Version": "2012-10-17",
   "Id": "Policy1415115909152",
   "Statement": [
     {
       "Sid": "Access-to-specific-VPCE-only",
       "Principal": "*",
       "Action": "s3:*",
       "Effect": "Deny",
       "Resource": ["arn:aws:s3:::test-s3-via-vpcendpoint",
                    "arn:aws:s3:::test-s3-via-vpcendpoint/*"],
       "Condition": {
         "StringNotEquals": {
           "aws:SourceVpce": "vpce-031b80325651f6bf5"
         }
       }
     }
   ]
}
```
