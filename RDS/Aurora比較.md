# やること
RDS VS Auroraのメモ

# 詳しくは文献（あくまでメモ）
- [AuroraかRDSどちらを選ぶべきか比較する話をDevelopers.IO 2019 in OSAKAでしました](https://dev.classmethod.jp/articles/developers-io-2019-in-osaka-aurora-or-rds/#toc-9)

# インスタンスタイプ
- Auroraはt系とr系（メモリ最適化）のみ
  - > Amazon Aurora は、2 種類のインスタンスクラス (メモリ最適化、バーストパフォーマンス) をサポートしています。
  - >https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/AuroraUserGuide/Concepts.DBInstanceClass.html
  
# 料金
https://aws.amazon.com/jp/rds/pricing/

|  | インスタンス料金/h | ストレージ/GB・月 | IO料金/100万リクエスト |
----|---- |---- |---- 
| RDS posgre m5.large（マルチAZ） | 0.494USD |0.276USD | \- |
| RDS posgre r5.large（マルチAZ） | 0.60USD |0.276USD| \- |
| Aurora r5.large（リードレプリカ1台とした場合） | 0.7USD(0.35*2) | 0.12USD |0.24USD |

- r5 -> vCPU: 2 Memory: 16 GiB
- m5 -> vCPU: 2 Memory: 8 GiB

# 特徴
## 6つのAZにストレージを分散・共有（書き込みが早い）
- パフォーマンスが早い理由。書き込みが早い理由
  - RDSならマスタースレーブでストレージは別個にあるので、それぞれに書き込み
- >書き込みは4/6、読み込みは3/6のストレージで成功したらクライアントに処理成功と返すことになっています。

### Protection Groups（可用性向上。リストアが早い、オーロラ独自機能）
- ストレージは10GBごとにノードに分かれて構成されている
  - >ストレージは10GBごとに3AZにまたがって6つのコピーを持つ構成になっています。この10GBの塊のことをProtection Groupと言います。
- >RDSの場合、直近のスナップショットデータから、それ以降のログを逐次適用していくことでリカバリを行ないます。このログ適用量が多いと、リカバリ完了までに何時間もかかったりします。 
- >対してAuroraの場合。直近のスナップショットから全Protection Group 並列でログ適用が行われます。一つ一つのProtection Groupは最大10GBなので、処理が長期化することはありません。


## リードレプリカのパフォーマンス（読み込みが早い）
- RDSの場合のリードレプリカも別個にストレージを持っているのでパフォーマンスの70%は書き込みに費やされる
- オーロラのリードレプリカは100%読み込みに使える。なぜならストレージを共有しているから

## クラスタキャッシュ管理（CCM）による高速リカバリ（可用性、オーロラ独自機能）
- 従前のオーロラではフェイルオーバーに要する30秒後、元のパフォーマンスを取り戻すのに340秒要した。
  - RDSも同じ考え方でフェイルオーバーの1min後、時間はかかるのだろう。 
- 優先度の高いリードレプリカに常にプライマリがキャッシュを含むデータ情報を伝達。レプリカはその情報を元にストレージからデータをロード。これによって30secのフェイルオーバー後すぐにパフォーマンスを取り戻す

## Parallel Query（読み書きパフォーマンス向上、オーロラ独自機能）
- >クエリ実行やトランザクション処理などは、インスタンス層（Database Node )の仕事です。ですが、実はストレージ層にもCPUが存在しています。しかも数千個と大量に存在しています。これらは普段はディスクの読み書きの用途に使われているのですが、インスタンス層がやっているクエリ実行などの処理をそのストレージ層のリソースにオフロードして、ストレージ側で処理してしまおうというのが並列クエリです。このことによってクエリ実行処理が爆速化します。
- >NETFLIXはAuroraのインスタンスタイプをr3.8xlargeからr3.2xlargeにスペックダウンすることができたそうです。

## Global Database
- ストレージレイヤでのリージョン間レプリケーション
- >プライマリインスタンスがあるリージョンが完全に停止したとして、別のリージョンにプライマリインスタンスを置いて復旧再稼働するのに、通常1分以内しかかかりません。さらに嬉しいことに、このレプリケーションはストレージだけで行われるものですので、レプリケーション先にインスタンスを設置しなくてもレプリケーションが可能です。これにより低価格でDR対策構成が実現できます。

## 3つのエンドポイントがある
## ログレコード
- インスタンス・ストレージ間にはログレコードと呼ばれる8KBよりも小さい単位で通信している
  - ログレコード：更新差分。これをストレージの末尾に追記していく
- 通常のRDSの場合はデータベースページというデータを通信（Postgresだと8KB）

## レプリカのオートスケーリングも可能


## パラメータグループ
- クラスターパラメータグループとインスタンスパラメータグループ
- クラスターはDB全体に反映、インスタンスが特定のインスタンスにだけ。競合した場合はインスタンスパラメーターが優先

### 自動バックアップはRDSと同じ1-35日
