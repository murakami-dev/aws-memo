
# 文献
- [Blackbelt](https://d1.awsstatic.com/webinars/jp/pdf/services/20200812_AWS-BlackBelt-Macie.pdf)


# 総論
- すべてのS3バケットをスキャンするのではなく、選択したものだけスキャンする仕組み
- utf8のみ対応。日本語のJISは非対応
- しかしMacie の管理画面ですべてのS3バケットの状況サマリー、それぞれのバケットの詳細を確認して、スキャン対象のバケットを指定できるようにはなっている
  - バケットの状況確認は現在ストレージレンズの方が良い。当時はバケット状況を確認するにはMacieしかなかった。
- 2020.8現在、S3のみサポートしている。DBをスキャンする場合はS3にエクスポートする必要があるが、膨大でありリアルタイム分析できないため現実的ではない。

## 利用の流れ
- アカウントのバケットを俯瞰する
- スキャンするバケットの決定
- 検出結果の参照
- 管理・運用。制約の把握

# 機微情報検出方法
https://docs.aws.amazon.com/macie/latest/user/managed-data-identifiers.html
- キーワードが入っているかチェック
- キーワードから近い位置（距離が短い）に機微情報があるかをチェック

## 注意
- マネージド識別子
  - キーワードは英語ベース（日本語は検知しない）
  - 姓名・住所はキーワード必要なしだが、ラテン言語の文字セット（英語、スペイン語、ドイツ語など）に限定
  - パスポート番号についてはアメリカ、カナダ、フランス等の形式にしか対応していない
  - クレジットカード番号はキーワード不要でJCBやVISAなど対応していて使えそう。
  - 認証情報は使えそう
  - サポートされている文字コードはUTF-8 のみがサポートされている。他の文字コード（Shift_JIS、EUC）の文字が入ったファイルはスキャン対象外となる（スキップされる）
- カスタムデータ識別子（**日本語対応**）
  - 検知するものを正規表現で定義。オプションでキーワードなどを設定する
![image](https://user-images.githubusercontent.com/60077121/99395923-7301ee80-2924-11eb-88fb-2af36afa5123.png)


- ジョブ
  - ワンタイムジョブ
  - スケジュール実行
    - `既存のオブジェクトを含める`のチェックを外すことで差分チェック（1回スキャンしたオブジェクトはスキャンしない）
    - 毎日、毎週、毎月を選択可能（ジョブが実行される時間帯や日付を指定することは出来ない）

## スキャンスコープの設定
- サンプリング深度（**料金節約に有効**）
  - デフォルトは100-> 100%のオブジェクトをスキャンする
  - 80を設定すると80%のオブジェクトをスキャンする（抜き打ちチェック）
- スキャンスコープ設定
  - スキャン対象にする条件、除外する条件を設定可能
  - 拡張子、サイズ、タグなど。
  
# 暗号化されたバケット
- SSE-S3, AWS-KMS, SSE-KMS による暗号化が行われている場合、 Macieはバケットをスキャンすることが可能
  - `SSE-KMS の場合には、Macie のサービスリンクロールAWSServiceRoleForAmazonMacie に CMK へのアクセス権限の付与が必要`
- クライアントでアップする前に暗号化しているものはスキャン不可
  - `クライアントサイド暗号化、カスタマー提供型のサーバーサイド暗号化（SSE-C）の場合には、復号する手段が無いため、Macie はスキャンが出来ない`

# サポートするファイル
![image](https://user-images.githubusercontent.com/60077121/99396390-06d3ba80-2925-11eb-9355-d34043ad8b12.png)

# 検出結果の参照
- 何行目にその機微情報があったとかは見れない。実際にファイルの中身探すしかない

## アクションの実行
- 30日しか保管できない。別のS3へ保存するかJSONでエクスポートするかして保存すること

# 管理・運用
- マルチアカウント対応
  - メンバーに対してジョブを実行できる
- リスク
```
  - Macie は Amazon S3 のデータをスキャンするが、データそのものや、スキャン結果が勝手に利用されることはないか？
    - Macie によるスキャンデータは解析のためにメモリー上で一時的に保持されるが、他のストレージにコピーされることはない
    - スキャン以外の目的で Macie のサービスは、お客様の S3 のデータにアクセスしたり、スキャン結果を利用することはない
    - Macie によるスキャン、分類結果は、暗号化されたストレージに保管される
    - Amazon S3 と Macie の間の通信は暗号化される
```

# 料金
- 課金対象は2つ
  - バケット数
  - 検出対象のデータ処理量
- スキャン時のGET、LISTリクエストのS3料金も発生
![image](https://user-images.githubusercontent.com/60077121/99397711-c37a4b80-2926-11eb-98b4-4891a5b96dc5.png)

# 利用する
- 有効化

