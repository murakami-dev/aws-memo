# 概要
- マネージドインスタンスに表示されない時のチェック項目と解法
- メタデータにアクセスできないときがある

# 文献
- [Systems Manager コンソールの [マネージドインスタンス] に EC2 インスタンスが表示されないのはなぜですか?](https://aws.amazon.com/jp/premiumsupport/knowledge-center/systems-manager-ec2-instance-not-appear/)
- [Amazon EC2 Windows インスタンスが「メタデータサービスの待機中」(Waiting for the metadata service) エラーを生成するのはなぜですか?](https://aws.amazon.com/jp/premiumsupport/knowledge-center/waiting-for-metadata/)
- [SSM エージェント ステータスの確認とエージェントの起動](https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/ssm-agent-status-and-restart.html)

# 手順
## 基本的なことの確認
- インターネット疎通
- IAMロール
- SSMエージェントの起動確認
  - [SSM エージェント ステータスの確認とエージェントの起動](https://docs.aws.amazon.com/ja_jp/systems-manager/latest/userguide/ssm-agent-status-and-restart.html) 

## それでも解決しないとき
- `telnet`で疎通確認

### まずはtelnetの機能を追加
- サーバマネジャの機能の追加から`telnet client`追加

### インスタンスメタデータへの接続に失敗する
```
PS C:\Users\hiroya> telnet 169.254.169.254 80
Connecting To 169.254.169.254...Could not open connection to the host, on port 80: Connect failed
```

### 文献2のとおりroute printする
- このインスタンスのIPは`10.123.10.246`なのでGateway（ルータのアドレス）は10.123.10.1
```
PS C:\Users\hiroya> route print
===========================================================================
Interface List
 16...06 30 b8 5b 99 cc ......Amazon Elastic Network Adapter
  1...........................Software Loopback Interface 1
===========================================================================

IPv4 Route Table
===========================================================================
Active Routes:
Network Destination        Netmask          Gateway       Interface  Metric
          0.0.0.0          0.0.0.0      10.123.10.1    10.123.10.246     15
      10.123.10.0    255.255.255.0         On-link     10.123.10.246    271
    10.123.10.246  255.255.255.255         On-link     10.123.10.246    271
    10.123.10.255  255.255.255.255         On-link     10.123.10.246    271
        127.0.0.0        255.0.0.0         On-link         127.0.0.1    331
        127.0.0.1  255.255.255.255         On-link         127.0.0.1    331
  127.255.255.255  255.255.255.255         On-link         127.0.0.1    331
  169.254.169.123  255.255.255.255      10.123.11.1    10.123.10.246     30
  169.254.169.249  255.255.255.255      10.123.11.1    10.123.10.246     30
  169.254.169.250  255.255.255.255      10.123.11.1    10.123.10.246     30
  169.254.169.251  255.255.255.255      10.123.11.1    10.123.10.246     30
  169.254.169.253  255.255.255.255      10.123.11.1    10.123.10.246     30
  169.254.169.254  255.255.255.255      10.123.11.1    10.123.10.246     30　　#Gatewayが10.123.10.1ではない
        224.0.0.0        240.0.0.0         On-link         127.0.0.1    331
        224.0.0.0        240.0.0.0         On-link     10.123.10.246    271
  255.255.255.255  255.255.255.255         On-link         127.0.0.1    331
  255.255.255.255  255.255.255.255         On-link     10.123.10.246    271
===========================================================================
Persistent Routes:
  Network Address          Netmask  Gateway Address  Metric
  169.254.169.254  255.255.255.255      10.123.11.1      15
  169.254.169.250  255.255.255.255      10.123.11.1      15
  169.254.169.251  255.255.255.255      10.123.11.1      15
  169.254.169.249  255.255.255.255      10.123.11.1      15
  169.254.169.123  255.255.255.255      10.123.11.1      15
  169.254.169.253  255.255.255.255      10.123.11.1      15
===========================================================================
```


